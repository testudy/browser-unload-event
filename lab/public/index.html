<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>beforeunload vs unload vs pagehide</title>
</head>
<body>
    <h2>操作步骤：</h2>
    <ol>
        <li>手工关闭当前浏览器窗口；</li>
        <li>手工在地址栏输入其他页面地址或从收藏夹、历史记录中将页面导航其他页面；</li>
        <li>手工单击后退，前进，刷新，或主页按钮。</li>
    </ol>
    <a href="/sub" id="A">点击一个链接到新页面</a><br />
    <button onclick="document.getElementById('A').click()">调用 anchor.click 方法</button><br />
    <button onclick="document.write('A')">调用 document.write 方法</button><br />
    <button onclick="document.open('/sub')">调用 document.open 方法</button><br />
    <button onclick="document.close()">调用 document.close 方法</button><br />
    <button onclick="window.open('/sub','_self')">调用 window.open方法，窗口名称设置值为 _self</button><br />
    <button onclick="try{window.navigate('/sub')}catch(e){alert('不支持此方法')}">调用 window.navigate 方法</button><br />
    <button onclick="try{window.external.NavigateAndFind('/sub','','')}catch(e){alert('不支持此方法')}">调用 NavigateAndFind 方法</button><br />
    <button onclick="location.replace('/sub')">调用 location.replace 方法</button><br />
    <button onclick="location.reload()">调用 location.reload 方法</button><br />
    <button onclick="location.href='/sub'">指定一个 location.href 属性的新值</button><br />
    <form action="/sub" id="B">
        <input type="submit" value="提交具有 action 属性的一个表单">
    </form>
    <button onclick="document.getElementById('B').submit()">调用 form.submit 方法</button><br />
    <a href="javascript:void(0)">调用 javascipt: 伪协议</a><br />
    <a href="mailto:">调用 mailto: 伪协议</a><br />
    <a href="custom:">调用自定义伪协议</a>

    <script>
    function wait(ms) {
        var now = new Date().getTime();
        while(new Date() - ms <= now) {}
    }

    function sendXhr(url, data, isAsync) {
        var xhr = new XMLHttpRequest();
        isAsync = isAsync === undefined ? true : isAsync;
        xhr.open('POST', '/report/' + url, isAsync);
        xhr.setRequestHeader('Content-Type', 'text/plain');
        xhr.send(JSON.stringify(data));
    }

    window.onbeforeunload = function () {
        var isAsync = true,
            isWait = false;
        sendXhr('beforeunload', {
            isAsync: isAsync,
            isWait: isWait,
            type: 'beforeunload',
            timestramp: (new Date()).getTime(),
            userAgent: navigator.userAgent,
        });
        //wait(1000);
    };

    window.onpagehide = function () {
        var isAsync = true,
            isWait = false;
        sendXhr('pagehide', {
            isAsync: isAsync,
            isWait: isWait,
            type: 'pagehide',
            timestramp: (new Date()).getTime(),
            userAgent: navigator.userAgent,
        });
        //wait(1000);
    };

    window.onunload = function () {
        var isAsync = true,
            isWait = false;
        sendXhr('unload', {
            isAsync: isAsync,
            isWait: isWait,
            type: 'unload',
            timestramp: (new Date()).getTime(),
            userAgent: navigator.userAgent,
        });
        //wait(1000);
    };

    </script>
</body>
</html>
